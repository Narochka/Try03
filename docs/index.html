<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>Try03 AR</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #unity-container, #unity-canvas { width:100%; height:100%; }
    #loading-cover { display:none; position:absolute; top:0; left:0; right:0; bottom:0;
                     background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
    #spinner { width:64px; height:64px; border:8px solid rgba(255,255,255,0.2);
               border-left-color:white; border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #start-button {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      padding:20px 40px; font-size:1.2em; background:#0078d7; color:white;
      border:none; border-radius:8px; cursor:pointer;
    }
    </style>
</head>
<body>
    <!-- КНОПКА ЗАПУСКА -->
    <button id="start-button">Нажмите, чтобы запустить AR</button>

    <!-- КОНТЕЙНЕР ДЛЯ UNITY -->
    <div id="unity-container" style="visibility:hidden;">
        <canvas id="unity-canvas"></canvas>
        <div id="loading-cover">
            <div id="spinner"></div>
        </div>
    </div>

    <!-- Zappar CV -->
    <script src="https://libs.zappar.com/zappar-cv/2.1.9/zappar-cv.js"></script>
    <script>
      // iOS-фикс индексированной БД
      indexedDB.open("dummy_indexdb", 1);

      const buildUrl    = "Build",
            loaderUrl   = buildUrl + "/Build.loader.js",
            config      = {
              dataUrl: buildUrl + "/Build.data",
              frameworkUrl: buildUrl + "/Build.framework.js",
              codeUrl: buildUrl + "/Build.wasm",
              streamingAssetsUrl: "StreamingAssets",
              companyName: "DefaultCompany",
              productName: "Try03",
              productVersion: "0.1",
              cacheControl: url => {
                if (url.match(/\.data$|\.bundle$|\.zpt$/)) return "must-revalidate";
                if (url.match(/\.mp4$|\.custom$|\.zbin$/)) return "immutable";
                return "no-store";
              }
            };

      const container      = document.getElementById("unity-container");
      const canvas         = document.getElementById("unity-canvas");
      const loadingCover   = document.getElementById("loading-cover");
      const startButton    = document.getElementById("start-button");

      // Инициализируем Zappar CV
      window.zappar = ZCV.initialize();

      startButton.addEventListener("click", async () => {
        // 1) Скрываем кнопку
        startButton.style.display = "none";
        // 2) Запрашиваем разрешение (камера + AudioContext) у пользователя
        await window.zappar.permission_request_ui_promise();
        // 3) Показываем контейнер Unity
        container.style.visibility = "";
        // 4) Загружаем билд
        loadUnity();
      });

      function loadUnity() {
        // Вставляем скрипт-лоадер Unity
        const s = document.createElement("script");
        s.src = loaderUrl;
        document.body.appendChild(s);

        // Начинаем отображать лоадер
        loadingCover.style.display = "flex";

        // После загрузки loader.js — создаём инстанс Unity
        s.onload = () => {
          createUnityInstance(canvas, config, progress => {
            // обновляем индикатор загрузки (можно расширить)
            // например: progressBarFull.style.width = `${progress * 100}%`;
          }).then(unityInstance => {
            // Скрыть лоадер
            loadingCover.style.display = "none";
            window.uarGameInstance = unityInstance;
          }).catch(err => {
            alert("Ошибка запуска Unity: " + err);
          });
        };
      }
    </script>
</body>
</html>
