<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Try03 AR</title>
  <link rel="shortcut icon" href="favicon.ico">
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #unity-container { visibility:hidden; width:100%; height:100%; position:relative; }
    #unity-canvas { width:100%; height:100%; background:#000; }
    #start-button {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      padding:16px 32px; font-size:1.1em; background:#0064c8; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
    #loading-cover {
      display:none; position:absolute; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.8); align-items:center; justify-content:center;
    }
    #spinner {
      width:48px; height:48px; border:6px solid rgba(255,255,255,0.3);
      border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div id="unity-container">
    <canvas id="unity-canvas"></canvas>
    <div id="loading-cover">
      <div id="spinner"></div>
    </div>
  </div>
  <button id="start-button">Нажмите для запуска AR</button>

  <!-- Подключаем проверенную версию Zappar CV -->
  <script src="https://libs.zappar.com/zappar-cv/2.1.9/zappar-cv.js"></script>
  <script>
    // iOS IndexedDB-фикс
    indexedDB.open("dummy_indexdb", 1);

    const buildUrl = "Build";
    const config = {
      dataUrl: `${buildUrl}/Build.data`,
      frameworkUrl: `${buildUrl}/Build.framework.js`,
      codeUrl: `${buildUrl}/Build.wasm`,
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "Try03",
      productVersion: "0.1",
      cacheControl: url => {
        if (url.endsWith(".data")||url.endsWith(".bundle")||url.endsWith(".zpt")) return "must-revalidate";
        if (url.match(/\.(mp4|custom|zbin)$/)) return "immutable";
        return "no-store";
      }
    };

    const container    = document.getElementById("unity-container");
    const canvas       = document.getElementById("unity-canvas");
    const loadingCover = document.getElementById("loading-cover");
    const startButton  = document.getElementById("start-button");

    // Инициализируем Zappar CV
    window.zappar = ZCV.initialize();

    startButton.addEventListener("click", async () => {
      startButton.style.display = "none";
      // ждем разрешения камеры и аудио
      await window.zappar.permission_request_ui_promise();
      container.style.visibility = "";
      loadingCover.style.display = "flex";
      // подгружаем Unity loader
      const script = document.createElement("script");
      script.src = `${buildUrl}/Build.loader.js`;
      script.onload = () => {
        createUnityInstance(canvas, config, prog => {
          /* можно отрисовать прогресс: prog*100% */
        }).then(unityInstance => {
          loadingCover.style.display = "none";
          window.uarGameInstance = unityInstance;
        }).catch(e => alert("Ошибка Unity: "+e));
      };
      document.body.appendChild(script);
    });
  </script>
</body>
</html>
